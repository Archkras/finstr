---
title: "Visualize Balance Sheets"
author: "Darko Bergant"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualize Balance Sheets}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r, echo=FALSE, results='hide', message=FALSE }
library(dplyr)
library(tidyr)
library(finstr)
data(xbrl_data_aapl2013)
data(xbrl_data_aapl2014)
```


## Get data
Use XBRL package to parse XBRL files. For example:
```{r xbrl_parse_min, eval=FALSE, echo=TRUE}
library(XBRL)
# parse XBRL (Apple 10-K report)
xbrl_url2014 <- 
  "http://edgar.sec.gov/Archives/edgar/data/320193/000119312514383437/aapl-20140927.xml"
xbrl_url2013 <- 
  "http://edgar.sec.gov/Archives/edgar/data/320193/000119312513416534/aapl-20130928.xml"
xbrl_data_aapl2014 <- xbrlDoAll(xbrl_url2014)
xbrl_data_aapl2013 <- xbrlDoAll(xbrl_url2013)
```

## Prepare statements
With `xbrl_get_statements` convert XBRL data to *statements* object. 
```{r xbrl_get_statements}
library(finstr)

st2013 <- xbrl_get_statements(xbrl_data_aapl2013)
st2014 <- xbrl_get_statements(xbrl_data_aapl2014)
# merge all statements
st_all <- merge( st2013, st2014 )
# get balance sheets 
balance_sheet <- st_all$StatementOfFinancialPositionClassified
tail(balance_sheet,2)

```

## Prepare custom hierarchy
The only way to visualize a balance sheet is by exposing limited number a few values. 
The first step is then to aggregate a balance sheet to a small number of pieces.
We can use `expose` to specify these groups of elements. For example:

```{r expose}
bs_simple <- expose( balance_sheet,
  
  # Assets
  `Current Assets` = "AssetsCurrent",
  `Noncurrent Assets` = other("Assets"),
  # Liabilites and equity
  `Current Liabilities` = "LiabilitiesCurrent",
  `Noncurrent Liabilities` = other(c("Liabilities", "CommitmentsAndContingencies")),
  `Stockholders Equity` = "StockholdersEquity"
)

```

Balance sheet stays divided by **Assets** and **Liabilities and Equity**.
We only defined simplified hierarchy for the second level.

Function `expose` expects a list of vectors with element names.
Function `other` helps us identify elements without enumerating every single element.

The result of `expose` is a valid statement object:
```{r simple_bs}
# print simplified balance sheet
bs_simple
# check if valid
check_statement(bs_simple)

```



```{r graph1, fig.width=7.2}
library(ggplot2)

plot_double_stacked_bar(bs_simple)

```

Another option is to group by faceting balance sheet side instead of date:

```{r graph2, fig.width=7.2}

plot_double_stacked_bar(bs_simple, by_date = FALSE)

```









